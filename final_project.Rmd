---
title: "Final project"
author: "Xinyun (Stacy) Li, Qiuyue Kong, Wenxu Liu, Siwei Stella Zhu"
date: "12/1/2021"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


```{r}
library(tidyverse)
library(dplyr)
library(lubridate)
library(ggplot2)
library(caret)
library(MASS)
library(rpart)
library(randomForest)
```

```{r}
vaccine<-read.csv("COVID-19_Vaccinations_in_the_United_States_Jurisdiction.csv")
case_death<-read.csv("United_States_COVID-19_Cases_and_Deaths_by_State_over_Time.csv")
```



```{r}
USstate=c("AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS",
          "KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY",
          "NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV",
          "WI","WY")
case_death<-case_death %>% 
  transmute(date=mdy(submission_date),
            state=state,
            tot_case=tot_cases,
            tot_death=tot_death,
            new_case=new_case,
            new_death=new_death
            ) %>%
  filter(state %in% USstate) %>%
  filter(date >= as.Date("2021-01-01") & date<=as.Date("2021-11-30"))
```

```{r}
vaccine<-vaccine %>% 
  dplyr::select(c(1,3,13,14,15,16,17,18,19,26,28,30,32,34,36,38,40,42,43,44,46,47,48,50,51,52,54,55,56,58,60,62,64,66,67,68)) %>%
  rename(state=Location) %>% 
  mutate(date=mdy(Date)) %>%
  dplyr::select(-Date)
```

Combine two tables into #comb#
#new_comb_ma# contains only data in MA
```{r}
comb<-right_join(vaccine,case_death,by=c("date","state"))
#write.csv(comb,"bigtable.csv",row.names = FALSE)
new_comb_ma<-comb%>%
  filter(state=="MA")%>%
  arrange(date)
  #mutate(new_case=tot_case-lag(tot_case)) %>%
  #mutate(new_death=tot_death-lag(tot_death))%>%
  #mutate(new_adm=Administered-lag(Administered)) %>%
  #mutate(new_jj=Administered_Janssen-lag(Administered_Janssen)) %>%
  #mutate(new_moderna=Administered_Moderna-lag(Administered_Moderna))%>%
  #mutate(new_pfizer=Administered_Pfizer-lag(Administered_Pfizer))
```

The number of new cases against date in MA
```{r}
new_comb_ma%>%ggplot(aes(x=date))+
  geom_point(aes(y=new_case))+
  geom_vline(xintercept=as.Date("2021-07-03"),color="red")+
  geom_text(aes(x=as.Date("2021-04-30"),y=6700,label="Delta variant became dominant"))
```
The number of new death against date in MA
```{r}
new_comb_ma%>%ggplot(aes(date,new_death))+
  geom_point()+
  geom_vline(xintercept=as.Date("2021-07-03"),color="red")+
  geom_text(aes(x=as.Date("2021-08-30"),y=70,label="Delta variant became dominant"))
```

The change of new cases across all states
```{r}
comb%>%
  ggplot(aes(date,new_case,group=state))+
  geom_line(color='darkseagreen3',alpha=0.6)+
  geom_vline(xintercept=as.Date("2021-07-03"),color="red")+
  geom_text(aes(x=as.Date("2021-04-30"),y=40000,label="Delta variant became dominant"))
```
The change of new deaths across all states
```{r}
comb%>%
  ggplot(aes(date,new_death,group=state))+
  geom_line(color='darkseagreen3',alpha=0.6)+
  geom_vline(xintercept=as.Date("2021-07-03"),color="red")+
  geom_text(aes(x=as.Date("2021-08-30"),y=700,label="Delta variant became dominant"))
```

Classify the number of new cases into three categories (1: new case<=10000 on that day, 2: 10000<new case<=20000 on that day, 3: new case>20000 on that day)
Also classify the number of new deaths into three categories (1: new death<=200 on that day, 2: 200<new death<=400 on that day, 3: new death>400 on that day)
```{r}
clascomb<-comb%>%
  mutate(new_case_clas=ifelse(new_case<=10000,1,ifelse(new_case>20000,3,2)))%>%
  mutate(new_death_clas=ifelse(new_death<=200,1,ifelse(new_death>400,3,2)))
```

Randomly divide the table into one train set (70% data) and one test set(30% data)
```{r}
inTrain   <- createDataPartition(y = clascomb$new_case, p = 0.7, times = 1, list = FALSE)
train_set <- slice(clascomb, inTrain)
test_set  <- slice(clascomb, -inTrain)
```

Classification using decision tree model
```{r}
rpart_fit <- rpart(new_case_clas ~ Administered, data = train_set)
rpart_preds <- predict(rpart_fit, test_set)
rpart_res<-ifelse(rpart_preds<1.5,1,ifelse(rpart_preds>=2.5,3,2))
#rpart_preds
confusionMatrix(data = as.factor(rpart_res), reference = as.factor(test_set$new_case_clas),positive="1")
test_set%>%
  ggplot()+geom_point(aes(date,rpart_preds),color="red")+geom_point(aes(date,new_case_clas))
```
Classification using random forest model
```{r}
rf_fit <- randomForest(new_case_clas ~ Administered, data = train_set)
rf_preds <- predict(rf_fit, test_set)
rf_res<-ifelse(rf_preds<1.5,1,ifelse(rf_preds>=2.5,3,2))
#rpart_preds
confusionMatrix(data = as.factor(rf_res), reference = as.factor(test_set$new_case_clas),positive="1")
test_set%>%
  ggplot()+geom_point(aes(date,rf_preds),color="red")+geom_point(aes(date,new_case_clas))
```
Regression using random forest
```{r}
newcase_rf<-randomForest(new_case~Administered, data=train_set)
newcase_rf_pred<-predict(newcase_rf,test_set)
test_set%>%
  ggplot()+geom_point(aes(date,newcase_rf_pred),color="red")+geom_point(aes(date,new_case))
```


Divide the table into trainset and testset by date (cutoff point: 2021-07-31)
```{r}
trainset<-clascomb%>%
  filter(date <= as.Date("2021-7-31"))
testset<-clascomb%>%
  filter(date >as.Date("2021-07-31"))
#trainset
```

Machine learning using linear regression
```{r}
linearfit <- lm(new_case ~ Administered, data = trainset)
linear_pred <- predict(linearfit, testset)
data.frame(
  RMSE = RMSE(linear_pred, testset$new_case),
  R2 = R2(linear_pred, testset$new_case)
)
#testset%>%
#  ggplot()+geom_line(aes(date,rpart_preds1),color="red")+geom_point(aes(date,new_case))
ggplot(testset, aes(date, new_case) ) +
  geom_point() +
  stat_smooth(method = lm, formula = y ~ x)
```


Machine learning using random forest
```{r}
regr_rf<-randomForest(new_case~Administered, data=trainset)
regr_rf_pred<-predict(newcase_rf,testset)
testset%>%
  ggplot()+geom_point(aes(date,regr_rf_pred),color="red")+geom_point(aes(date,new_case))
plot(regr_rf)
sqrt(sum((regr_rf_pred - testset$new_case)^2) / nrow(testset))
```

